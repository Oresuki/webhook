-- Fish It Game Detector Script (V. Final - Notifikasi SetCore)
-- Menggunakan Proxy Pipedream + Notifikasi SetCore (seperti loader teman Anda) untuk feedback.

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local player = Players.LocalPlayer
local StarterGui = game:GetService('StarterGui')

-- URL PROXY PIPEDREAM ANDA SUDAH DIMASUKKAN DI SINI:
local WEBHOOK_URL = "https://eoul4wwmel3tjko.m.pipedream.net" 

-- Settings
local SEND_ALL_CATCHES = false 
local MIN_RARITY_TO_SEND = "Rare" 

-- Tabel colors dan priority tetap sama
local rarityColors = {
Â  Â  Common = 16777215, Uncommon = 5635925, Rare = 5592575, 
Â  Â  Epic = 11141375, Legendary = 16755200, Mythic = 16733695, 
Â  Â  SECRET = 16711680 
}
local rarityPriority = {
Â  Â  Common = 1, Uncommon = 2, Rare = 3, Epic = 4, Legendary = 5, Mythic = 6, SECRET = 7
}

-- FUNGSI BARU: Notifikasi Pop-up (Meniru SetCore dari Loader Anda)
local function notify(title, text, isSuccess)
    local icon = isSuccess and 'rbxassetid://6253907742' or 'rbxassetid://6253907405' -- Ikon centang atau silang
    pcall(function()
        StarterGui:SetCore('SendNotification', {
            Title = title,
            Text = text,
            Icon = icon,
            Duration = 5
        })
    end)
end

-- Function untuk send webhook ke Proxy
local function sendWebhook(embed)
    local requestFunc = http_request or request or (syn and syn.request)
    
    if not WEBHOOK_URL or not requestFunc then
        notify('WEBHOOK ERROR', 'Fungsi HTTP tidak ditemukan.', false)
        return false
    end

    local data = { ["embeds"] = {embed} }
    local jsonData = HttpService:JSONEncode(data)
    
    local success, result = pcall(function()
        return requestFunc({
            Url = WEBHOOK_URL,
            Method = "POST",
            Headers = { ["Content-Type"] = "application/json" },
            Body = jsonData
        })
    end)
    
    if success then
        -- Jika sukses, Pipedream akan menerima (walaupun mungkin gagal di sisi Discord jika Body Pipedream salah)
        return true
    else
        notify('WEBHOOK GAGAL KIRIM', 'Gagal kirim ke Proxy! Executor Anda mungkin memblokir jaringan.', false)
        return false
    end
end

-- Fungsi untuk menguji webhook
local function testWebhook()
    local embed = { 
        ["title"] = "ðŸ§ª Webhook Test (Otomatis)", 
        ["description"] = "Test message dari Fish Detector! Cek Discord Anda!", 
        ["color"] = 65280, 
        ["fields"] = { 
            { ["name"] = "Player", ["value"] = player.Name, ["inline"] = true }, 
            { ["name"] = "Status", ["value"] = "âœ… Tes Otomatis", ["inline"] = true } 
        }, 
        ["timestamp"] = os.date("!%Y-%m-%dT%H:%M:%SZ") 
    }
    local success = sendWebhook(embed)
    if success then
        notify('WEBHOOK SUKSES KIRIM', 'Data uji coba terkirim ke Pipedream. Periksa Discord!', true)
    end
    return success
end

-- Fungsi pendukung lainnya (parseBackpackFromGUI, shouldSendToDiscord) tetap sama.
local function parseBackpackFromGUI()
    local backpackData = { items = {}, totalWeight = 0, maxWeight = 4500, rarityCounts = { Common = 0, Uncommon = 0, Rare = 0, Epic = 0, Legendary = 0, Mythic = 0, SECRET = 0 } }
    local playerGui = player:WaitForChild("PlayerGui", 5)
    if not playerGui then return backpackData end
    for _, gui in pairs(playerGui:GetDescendants()) do
        if gui:IsA("TextLabel") or gui:IsA("TextBox") then
            local text = gui.Text
            local current, max = text:match("(%d+%.%d+)/(%d+%.%d+)")
            if current and max then
                backpackData.totalWeight = tonumber(current) * 1000
                backpackData.maxWeight = tonumber(max) * 1000
            end
            for rarity, _ in pairs(rarityPriority) do
                local count = text:match(rarity .. "%s*:%s*(%d+)") or text:match(rarity .. "%s*(%d+)")
                if count then backpackData.rarityCounts[rarity] = tonumber(count) end
            end
        end
    end
    return backpackData
end

local function monitorChat()
    local chatEvents = ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents")
    if chatEvents then
        local onMessageDoneFiltering = chatEvents:FindFirstChild("OnMessageDoneFiltering")
        if onMessageDoneFiltering then
            onMessageDoneFiltering.OnClientEvent:Connect(function(messageData)
                local message = messageData.Message
                if message:find("You Got:") or message:find("You got:") then
                    task.wait(1.5) 
                    local fishName = message:match("You [Gg]ot:%s*(.-)%s*%(") or message:match("You [Gg]ot:%s*(.-)%s*,") or "Unknown Fish"
                    local rarity = "Common"
                    for r, _ in pairs(rarityPriority) do
                        if message:lower():find(r:lower()) then rarity = r; break end
                    end

                    if shouldSendToDiscord(rarity) then
                        local bpData = parseBackpackFromGUI()
                        local rarityText = ""
                        for r, count in pairs(bpData.rarityCounts) do
                            if count > 0 then rarityText = rarityText .. string.format("%s: %d\n", r, count) end
                        end
                        local embed = {
                            ["title"] = "ðŸŽ£ Fish Caught! (" .. rarity .. ")",
                            ["description"] = string.format("**%s** telah tertangkap.", fishName),
                            ["color"] = rarityColors[rarity] or 16777215,
                            ["fields"] = {
                                { ["name"] = "ðŸŽ’ Backpack", ["value"] = string.format("**Weight:** %.2f/%.2f KG", bpData.totalWeight/1000, bpData.maxWeight/1000), ["inline"] = true },
                                { ["name"] = "âœ¨ Rarity Count", ["value"] = rarityText ~= "" and rarityText or "No items", ["inline"] = false }
                            },
                            ["footer"] = { ["text"] = player.Name .. " â€¢ Fish It Detector" },
                            ["timestamp"] = os.date("!%Y-%m-%dT%H:%M:%SZ")
                        }
                        local success = sendWebhook(embed)
                        if success then
                            notify('IKAN TERTANGKAP', fishName .. " (" .. rarity .. ") dikirim ke Discord!", true)
                        end
                    end
                end
            end)
        end
    end
end

-- Inisialisasi: Uji Coba Otomatis dan Mulai Monitoring
task.spawn(function()
    notify('NIGHTMARE LOADER', 'Fish Detector Loading...', true)
    task.wait(5) -- Tunggu 5 detik agar semua dimuat
    
    -- UJI COBA OTOMATIS: Dapatkan feedback langsung
    testWebhook()
    
    -- Mulai monitoring chat
    monitorChat()
    notify('NIGHTMARE LOADER', 'Fish Detector Aktif. Memonitor chat.', true)
end)
