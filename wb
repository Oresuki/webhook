-- Fish It Game Detector Script (V. Final - UI Manager)
-- Menggunakan UI sederhana untuk memasukkan Webhook URL dan menampilkan status.

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local player = Players.LocalPlayer
local StarterGui = game:GetService('StarterGui')

-- Variabel URL Webhook (akan diisi dari UI)
local WEBHOOK_URL = "https://eoul4wwmel3tjko.m.pipedream.net" 

-- Settings
local MIN_RARITY_TO_SEND = "Rare" 

-- [Kode Warna dan Prioritas Rarity tetap sama]
local rarityColors = {
Â  Â  Common = 16777215, Uncommon = 5635925, Rare = 5592575, 
Â  Â  Epic = 11141375, Legendary = 16755200, Mythic = 16733695, 
Â  Â  SECRET = 16711680 
}
local rarityPriority = {
Â  Â  Common = 1, Uncommon = 2, Rare = 3, Epic = 4, Legendary = 5, Mythic = 6, SECRET = 7
}

-- FUNGSI: Notifikasi Pop-up (menggunakan SetCore)
local function notify(title, text, isSuccess)
    local icon = isSuccess and 'rbxassetid://6253907742' or 'rbxassetid://6253907405'
    pcall(function()
        StarterGui:SetCore('SendNotification', {
            Title = title,
            Text = text,
            Icon = icon,
            Duration = 5
        })
    end)
end

-- FUNGSI: sendWebhook (Inti komunikasi HTTP)
local function sendWebhook(embed)
    local requestFunc = http_request or request or (syn and syn.request)
    
    if not WEBHOOK_URL or not requestFunc then
        notify('WEBHOOK ERROR', 'URL atau fungsi HTTP tidak ditemukan.', false)
        return false
    end

    local data = { ["embeds"] = {embed} }
    local jsonData = HttpService:JSONEncode(data)
    
    local success, result = pcall(function()
        return requestFunc({
            Url = WEBHOOK_URL,
            Method = "POST",
            Headers = { ["Content-Type"] = "application/json" },
            Body = jsonData
        })
    end)
    
    if not success then
        notify('WEBHOOK GAGAL KIRIM', 'Gagal kirim ke Proxy! Cek koneksi.', false)
    end
    return success
end

-- FUNGSI: Test Webhook (untuk UI)
local function testWebhook()
    local embed = { 
        ["title"] = "ðŸ§ª Webhook Test (Manual)", 
        ["description"] = "Test message dari Fish Detector! Cek Discord Anda!", 
        ["color"] = 65280, 
        ["fields"] = { 
            { ["name"] = "Player", ["value"] = player.Name, ["inline"] = true }, 
            { ["name"] = "Status", ["value"] = "âœ… Tes Manual", ["inline"] = true } 
        }, 
        ["timestamp"] = os.date("!%Y-%m-%dT%H:%M:%SZ") 
    }
    local success = sendWebhook(embed)
    if success then
        notify('WEBHOOK SUKSES KIRIM', 'Data uji coba terkirim ke Pipedream.', true)
    end
    return success
end

-- FUNGSI: Monitor Chat (Inti deteksi ikan)
local function monitorChat()
    local chatEvents = ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents")
    if chatEvents then
        local onMessageDoneFiltering = chatEvents:FindFirstChild("OnMessageDoneFiltering")
        if onMessageDoneFiltering then
            onMessageDoneFiltering.OnClientEvent:Connect(function(messageData)
                local message = messageData.Message
                if message:find("You Got:") or message:find("You got:") then
                    task.wait(1.5) 
                    local fishName = message:match("You [Gg]ot:%s*(.-)%s*%(") or message:match("You [Gg]ot:%s*(.-)%s*,") or "Unknown Fish"
                    local rarity = "Common"
                    for r, _ in pairs(rarityPriority) do
                        if message:lower():find(r:lower()) then rarity = r; break end
                    end

                    if rarityPriority[rarity] >= rarityPriority[MIN_RARITY_TO_SEND] then
                        local embed = {
                            -- ... (kode embed lengkap untuk ikan tertangkap) ...
                            ["title"] = "ðŸŽ£ Fish Caught! (" .. rarity .. ")",
                            ["description"] = string.format("**%s** telah tertangkap.", fishName),
                            ["color"] = rarityColors[rarity] or 16777215,
                            ["footer"] = { ["text"] = player.Name .. " â€¢ Fish It Detector" },
                            ["timestamp"] = os.date("!%Y-%m-%dT%H:%M:%SZ")
                        }
                        local success = sendWebhook(embed)
                        if success then
                            notify('IKAN TERTANGKAP', fishName .. " (" .. rarity .. ") dikirim ke Discord!", true)
                        end
                    end
                end
            end)
        end
    end
end

-- FUNGSI UI: Membuat Antarmuka Sederhana
local function createUI()
    local playerGui = player:WaitForChild("PlayerGui")
    
    local gui = Instance.new("ScreenGui")
    gui.Name = "FishDetectorUI"
    gui.ResetOnSpawn = false
    gui.Parent = playerGui

    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0, 300, 0, 150)
    mainFrame.Position = UDim2.fromScale(0.5, 0.5) -- Tengah layar
    mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    mainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = gui

    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 30)
    title.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Text = "FISH WEBHOOK CONFIG"
    title.Font = Enum.Font.SourceSansBold
    title.TextSize = 20
    title.Parent = mainFrame

    local urlBox = Instance.new("TextBox")
    urlBox.Size = UDim2.new(0.9, 0, 0, 30)
    urlBox.Position = UDim2.new(0.05, 0, 0.3, 0)
    urlBox.PlaceholderText = "Masukkan URL Proxy Pipedream..."
    urlBox.Text = WEBHOOK_URL 
    urlBox.TextColor3 = Color3.fromRGB(0, 0, 0)
    urlBox.TextSize = 14
    urlBox.Parent = mainFrame
    
    -- Event untuk mengupdate URL saat pengguna mengetik
    urlBox.Changed:Connect(function(property)
        if property == "Text" then
            WEBHOOK_URL = urlBox.Text
        end
    end)
    
    local testButton = Instance.new("TextButton")
    testButton.Size = UDim2.new(0.4, 0, 0, 30)
    testButton.Position = UDim2.new(0.05, 0, 0.6, 0)
    testButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
    testButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    testButton.Text = "TEST WEBHOOK"
    testButton.Font = Enum.Font.SourceSansBold
    testButton.TextSize = 16
    testButton.Parent = mainFrame

    -- Event untuk menguji webhook
    testButton.MouseButton1Click:Connect(function()
        if testWebhook() then
            testButton.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
            task.wait(1)
            testButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
        else
            testButton.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
            task.wait(1)
            testButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
        end
    end)

    local rarityButton = Instance.new("TextButton")
    rarityButton.Size = UDim2.new(0.4, 0, 0, 30)
    rarityButton.Position = UDim2.new(0.55, 0, 0.6, 0)
    rarityButton.BackgroundColor3 = Color3.fromRGB(0, 0, 150)
    rarityButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    rarityButton.Text = "Rarity: " .. MIN_RARITY_TO_SEND
    rarityButton.Font = Enum.Font.SourceSansBold
    rarityButton.TextSize = 16
    rarityButton.Parent = mainFrame
    
    -- Fungsi untuk mengganti rarity
    local rarityIndex = rarityPriority[MIN_RARITY_TO_SEND]
    local rarityList = {"Common", "Uncommon", "Rare", "Epic", "Legendary", "Mythic", "SECRET"}
    
    rarityButton.MouseButton1Click:Connect(function()
        rarityIndex = rarityIndex % #rarityList + 1
        MIN_RARITY_TO_SEND = rarityList[rarityIndex]
        rarityButton.Text = "Rarity: " .. MIN_RARITY_TO_SEND
        notify("SETTING", "Minimum Rarity diatur ke: " .. MIN_RARITY_TO_SEND, true)
    end)
end

-- Inisialisasi
pcall(createUI)
pcall(monitorChat)

notify('NIGHTMARE LOADER', 'Fish Detector Loaded. Cari kotak CONFIG di layar.', true)
