-- Fish It Game Detector Script (V. Akhir & Anti-Konsol)
-- Menggunakan Proxy Pipedream untuk mengatasi pemblokiran HTTP dan Tombol GUI untuk uji coba.

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local player = Players.LocalPlayer

-- URL PROXY PIPEDREAM ANDA SUDAH DIMASUKKAN DI SINI:
local WEBHOOK_URL = "https://eoul4wwmel3tjko.m.pipedream.net" 

-- Settings
local SEND_ALL_CATCHES = false -- Set true untuk kirim semua catch, false untuk rare saja
local MIN_RARITY_TO_SEND = "Rare" -- Minimum rarity untuk kirim ke Discord

-- Tabel rarity colors untuk Discord embed
local rarityColors = {
Â  Â  Common = 16777215, Uncommon = 5635925, Rare = 5592575, 
Â  Â  Epic = 11141375, Legendary = 16755200, Mythic = 16733695, 
Â  Â  SECRET = 16711680 
}

-- Tabel priority rarity
local rarityPriority = {
Â  Â  Common = 1, Uncommon = 2, Rare = 3, Epic = 4, Legendary = 5, Mythic = 6, SECRET = 7
}

-- Function untuk send webhook ke Proxy
local function sendWebhook(embed)
Â  Â  if not WEBHOOK_URL then
Â  Â  Â  Â  warn("âŒ Discord Webhook URL not configured!")
Â  Â  Â  Â  return false
Â  Â  end
Â  Â  
Â  Â  local data = {
Â  Â  Â  Â  ["embeds"] = {embed}
Â  Â  }
Â  Â  
Â  Â  local jsonData = HttpService:JSONEncode(data)
Â  Â  
Â  Â  local success, result
Â  Â  
Â  Â  -- Mencoba fungsi HTTP yang umum (http_request/request/syn.request)
Â  Â  local requestFunc = http_request or request or (syn and syn.request)
Â  Â  
Â  Â  if requestFunc then
Â  Â  Â  Â  success, result = pcall(function()
Â  Â  Â  Â  Â  Â  return requestFunc({
Â  Â  Â  Â  Â  Â  Â  Â  Url = WEBHOOK_URL,
Â  Â  Â  Â  Â  Â  Â  Â  Method = "POST",
Â  Â  Â  Â  Â  Â  Â  Â  Headers = { ["Content-Type"] = "application/json" },
Â  Â  Â  Â  Â  Â  Â  Â  Body = jsonData
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  end)
Â  Â  else
Â  Â  Â  Â  warn("âŒ No HTTP request function available.")
Â  Â  Â  Â  return false
Â  Â  end
Â  Â  
Â  Â  if success and result then
Â  Â  Â  Â  print("âœ… Webhook data sent to Proxy (Pipedream)!")
Â  Â  Â  Â  return true
Â  Â  else
Â  Â  Â  Â  warn("âŒ Failed to send data to Proxy: " .. tostring(result))
Â  Â  Â  Â  return false
Â  Â  end
end

-- Fungsi Pendukung (Tidak ada perubahan)
local function shouldSendToDiscord(rarity)
    if SEND_ALL_CATCHES then return true end
    local minPriority = rarityPriority[MIN_RARITY_TO_SEND] or 3
    local itemPriority = rarityPriority[rarity] or 1
    return itemPriority >= minPriority
end

local function printBackpackStatus()
    local data = parseBackpackFromGUI()
    -- Hanya cetak jika fungsi print benar-benar berfungsi
    if print then
        print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        print("ğŸ“¦ BACKPACK STATUS")
        print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        print(string.format("âš–ï¸ Weight: %.3f/%.3f KG (%.1f%%)", data.totalWeight/1000, data.maxWeight/1000, (data.totalWeight/data.maxWeight) * 100))
        print("\nâœ¨ Rarity Breakdown:")
        for rarity, count in pairs(data.rarityCounts) do
            if count > 0 then print(string.format(" Â %s: %d", rarity, count)) end
        end
        print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
    end
end

local function parseBackpackFromGUI()
    local backpackData = { items = {}, totalWeight = 0, maxWeight = 4500, rarityCounts = { Common = 0, Uncommon = 0, Rare = 0, Epic = 0, Legendary = 0, Mythic = 0, SECRET = 0 } }
    local playerGui = player:WaitForChild("PlayerGui", 5)
    if not playerGui then return backpackData end
    for _, gui in pairs(playerGui:GetDescendants()) do
        if gui:IsA("TextLabel") or gui:IsA("TextBox") then
            local text = gui.Text
            local current, max = text:match("(%d+%.%d+)/(%d+%.%d+)")
            if current and max then
                backpackData.totalWeight = tonumber(current) * 1000
                backpackData.maxWeight = tonumber(max) * 1000
            end
            for rarity, _ in pairs(rarityPriority) do
                local count = text:match(rarity .. "%s*:%s*(%d+)") or text:match(rarity .. "%s*(%d+)")
                if count then backpackData.rarityCounts[rarity] = tonumber(count) end
            end
        end
    end
    return backpackData
end

-- Monitor chat
local function monitorChat()
    local chatEvents = ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents")
    if chatEvents then
        local onMessageDoneFiltering = chatEvents:FindFirstChild("OnMessageDoneFiltering")
        if onMessageDoneFiltering then
            onMessageDoneFiltering.OnClientEvent:Connect(function(messageData)
                local message = messageData.Message
                if message:find("You Got:") or message:find("You got:") then
                    task.wait(1.5) 
                    local fishName = message:match("You [Gg]ot:%s*(.-)%s*%(") or message:match("You [Gg]ot:%s*(.-)%s*,") or "Unknown Fish"
                    local weight = message:match("weight:%s*([%d%.]+)") or "0"
                    local price = message:match("price:%s*(%d+)") or "0"
                    local mutations = message:match("mutations:%s*([^,%)]+)") or "None"
                    local rarity = "Common"
                    for r, _ in pairs(rarityPriority) do
                        if message:lower():find(r:lower()) then rarity = r; break end
                    end
                    if print then print("ğŸ£ FISH CAUGHT! (" .. fishName .. " - " .. rarity .. ")") end
                    task.wait(1)
                    printBackpackStatus()
                    if shouldSendToDiscord(rarity) then
                        local bpData = parseBackpackFromGUI()
                        local rarityText = ""
                        for r, count in pairs(bpData.rarityCounts) do
                            if count > 0 then rarityText = rarityText .. string.format("%s: %d\n", r, count) end
                        end
                        local embed = {
                            ["title"] = "ğŸ£ Fish Caught!",
                            ["description"] = string.format("**%s** has been caught!", fishName),
                            ["color"] = rarityColors[rarity] or 16777215,
                            ["fields"] = {
                                { ["name"] = "ğŸ“Š Fish Info", ["value"] = string.format("**Rarity:** %s\n**Weight:** %s KG\n**Price:** %s coins\n**Mutations:** %s", rarity, weight, price, mutations), ["inline"] = true },
                                { ["name"] = "ğŸ’ Backpack", ["value"] = string.format("**Weight:** %.2f/%.2f KG\n**Usage:** %.1f%%", bpData.totalWeight/1000, bpData.maxWeight/1000, (bpData.totalWeight/bpData.maxWeight) * 100), ["inline"] = true },
                                { ["name"] = "âœ¨ Rarity Count", ["value"] = rarityText ~= "" and rarityText or "No items", ["inline"] = false }
                            },
                            ["footer"] = { ["text"] = player.Name .. " â€¢ Fish It Detector" },
                            ["timestamp"] = os.date("!%Y-%m-%dT%H:%M:%SZ")
                        }
                        sendWebhook(embed)
                    end
                end
            end)
        end
    end
end

-- FUNGSI BARU: Tombol Uji Coba Webhook di Layar Game
local function createTestButton()
    local playerGui = player:WaitForChild("PlayerGui")
    
    local notifGui = Instance.new("ScreenGui")
    notifGui.Name = "FishDetectorTestButton"
    notifGui.Parent = playerGui

    local button = Instance.new("TextButton")
    button.Size = UDim2.new(0, 200, 0, 40)
    button.Position = UDim2.new(0, 10, 0, 100) -- Posisi di kiri atas
    button.BackgroundColor3 = Color3.fromRGB(0, 100, 0)
    button.Text = "TEST WEBHOOK (PROXY)"
    button.TextColor3 = Color3.new(1, 1, 1)
    button.Font = Enum.Font.SourceSansBold
    button.TextSize = 18
    button.Parent = notifGui
    
    local function testAndNotify()
        local embed = { ["title"] = "ğŸ§ª Webhook Test (Tombol)", ["description"] = "Test message from Fish It Detector!", ["color"] = 65280, ["fields"] = { { ["name"] = "Player", ["value"] = player.Name, ["inline"] = true }, { ["name"] = "Status", ["value"] = "âœ… Proxy Connected", ["inline"] = true } }, ["timestamp"] = os.date("!%Y-%m-%dT%H:%M:%SZ") }
        local success = sendWebhook(embed)

        if success then
            button.BackgroundColor3 = Color3.fromRGB(0, 200, 0) -- Hijau terang
            button.Text = "âœ… TEST SUCCESS!"
        else
            button.BackgroundColor3 = Color3.fromRGB(200, 0, 0) -- Merah
            button.Text = "âŒ TEST FAILED!"
        end
        task.wait(3)
        button.BackgroundColor3 = Color3.fromRGB(0, 100, 0)
        button.Text = "TEST WEBHOOK (PROXY)"
    end
    
    button.MouseButton1Click:Connect(testAndNotify)
    
    if print then print("Tombol Test Webhook sudah dibuat di GUI Anda.") end
end

-- Initialize
if print then 
    print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
    print("ğŸ£ Fish It Detector Script Loaded!")
    print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
    print("â¡ï¸ Proxy URL: " .. WEBHOOK_URL)
    print("ğŸ“Š Min Rarity: " .. MIN_RARITY_TO_SEND)
    print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
end

-- Buat tombol uji coba dan mulai monitoring
pcall(createTestButton)
pcall(monitorChat)
pcall(printBackpackStatus)
